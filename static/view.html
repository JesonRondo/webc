<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, height=device-height, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
  <title>hihi</title>
</head>
<body>
  <div id="app"></div>
  <script>
    window.viewKit = (function () {
      var head

      var getHead = function () {
        return head || (head = document.head || document.getElementsByTagName('head')[0])
      }

      var generatorDom = function (node, parent) {
        var dom

        if (node.type === 'text') {
          // 文本节点
          dom = document.createTextNode(node.data)
          parent && parent.appendChild(dom)
          return dom
        // } else if (node.nodeType === 8) {
          // 注释节点
        } else if (node.type === 'tag') {
          // 普通节点
          dom = document.createElement(node.name)
          parent && parent.appendChild(dom)

          // 属性
          if (node.attribs) {
            for (var k in node.attribs) {
              dom.setAttribute(k, node.attribs[k])
            }
          }

          // 孩子
          if (node.children) {
            node.children.forEach(function (child) {
              generatorDom(child, dom)
            })
          }
          return dom
        }
      }

      var messageHandle = function (cmd, payload) {
        var id, styleElement

        switch (cmd) {
          case 'mount':
            const node = typeof payload.html === 'string'
              ? JSON.parse(payload.html)
              : payload.html
            document.getElementById('app').outerHTML = generatorDom(node).outerHTML
            break

          case 'addStyleElement':
            id = payload.element.id
            styleElement = document.createElement('style')
            styleElement.type = 'text/css'
            styleElement.setAttribute('id', id)
            getHead().appendChild(styleElement)
            break

          case 'appendStyleNode':
            id = payload.element.id
            styleElement = document.getElementById(id)
            var css = unescape(payload.node)
            styleElement.appendChild(document.createTextNode(css))
            break

          default:
            console.log(cmd, payload)
            break
        }
      }

      window.addEventListener('message', function (e) {
        if (e.origin !== 'http://localhost:8080') {
          return
        }

        var cmd = e.data.cmd
        var payload = e.data.payload

        messageHandle(cmd, payload)
      }, false)

      return {
        messageHandle: messageHandle
      }
    })()
  </script>
</body>
</html>